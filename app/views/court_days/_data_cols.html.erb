        <div class="span<%= date_span %> weekday">
          <span>
<% date = court_day.date
   if admin? && !date.expired? %>
            <%= submit_tag( "#{ t( 'general.cwday')[ date.cwday]}") %>
<% else %>
            <%= t( "general.cwday")[ date.cwday] %>
<% end %>
          </span>
          <span class="court-day-date"><%= date %></span>
        </div>
<% offset = 0
   [ :morning, :afternoon].each do |session|
     parallel = court_day.send( session)
     bookings = court_day.send( "#{ session}_bookings")
     taken = bookings.count
     booked = current_user.booked? court_day, session
     if (!admin? || session.expired?) && parallel == 0 && taken == 0
       offset += session_span
     else %>
          <div class="<%= offset_n_span_to_class( offset, session_span)
                       %>" id="<%= "court-day-#{ date}-#{ session}" %>">
<%     if (taken < parallel) || (!session.expired? && (admin? || booked)) %>
            <div class="row">
              <div class="span<%= session_span %>">
<%       if session.expired?
           if taken < parallel %>
                <%= t( "court_session.need.not_met",
                       count: parallel - taken) %>
<%         end
         elsif admin? %>
                <div style="float:left">
                  <%= label_tag session, t( "court_session.need.label") %>
                  <%= select_tag "#{ session}-#{ date}",
                    options_for_select( (PARALLEL_SESSIONS_MAX + 1).times.
                                          inject( [ ]){ |acc, n| acc << n},
                                        parallel),
                    :class => "parallel-sessions" %>
                </div>
<%         if taken < parallel
             days_to_go = court_day.date - Date.today
             if days_to_go < BOOKING_DAYS_AHEAD_MIN %>
                <div class="to-book immediate">
<%           elsif days_to_go < BOOKING_DAYS_AHEAD_MAX %>
                <div class="to-book urgent">
<%           else %>
                <div class="to-book">
<%           end %>
                  <%= t( "court_session.need.left.long",
                         count: parallel - taken) %>
                </div>
<%         elsif  taken > parallel %>
                <div class="overbooked">
                  <%= t( "court_session.need.over").capitalize %>
                </div>
<%         end %>
<%       elsif booked
           if taken > parallel %>
                <div class="overbooked">
<%         end %>
                  <%= submit_tag t( "booking.#{ session}.unbook") %>
<%         if taken > parallel %>
                  (<%= t( "court_session.need.over") %>)
                </div>
<%         elsif taken < parallel %>
                (<%= t( "court_session.need.left.short",
                        count: parallel - taken) %>)
<%         end
         elsif taken < parallel %>
                <%= submit_tag t( "booking.#{ session}.book") %>
                (<%= t( "court_session.need.left.short",
                        count: parallel - taken) %>)
<%       end %>
              </div>
            </div>
<%     end
       bookings.each do |booking| %>
            <div class="row">
              <div class="span<%= session_span %>">
<%       if current_user? booking.user %>
                <b>
<%       end
         if admin? && !booking.expired? %>
                <%= link_to booking.user.name, booking_path( booking),
                            method: :delete,
                            data: { confirm:
                                    t( "booking.unbook.confirm",
                                       name: booking.user.name,
                                       date: booking.court_day.date,
                                       session: t( "booking.#{ booking.session
                                                             }.short"))} %>
<%       else %>
                <%= booking.user.name %>
<%       end
         if current_user? booking.user %>
                </b>
<%       end %>
              </div>
            </div>
<%     end %>
          </div>
<%     offset = 0
     end
   end  # [ :morning, :afternoon].each do |session|
   if admin? && !date.expired?
     # the following is to prevent browser automatic fill-in
     note = court_day.note.blank? ? " " : court_day.note %>
          <div class="span<%= note_span %>">
            <div class="row">
              <div class="span<%= note_span %>">
                <%= text_area_tag "note-#{ date}", note %>
              </div>
            </div>
          </div>
<% elsif !court_day.note.blank? %>
          <div class="<%= offset_n_span_to_class( offset, note_span) %>">
            <%= h( court_day.note).gsub( "\n", "<br/>").html_safe %>
          </div>
<% end %>

